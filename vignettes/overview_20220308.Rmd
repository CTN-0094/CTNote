---
title: "Overview of the CTNote Library"
author: "Gabriel Odom, Laura Brandt, Sean Luo, and Ray Balise"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{CTNote Overview}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, load-packages, include=FALSE}
library(ctn0094data)
library(ctn0094DataExtra)
library(CTNote)
library(readxl)
library(kableExtra)
library(tidyverse)
```

# Introduction and Motivation

## Background

Over 750,000 Americans have died from a drug overdose [since 1990](https://www.hhs.gov/opioids/about-the-epidemic/opioid-crisis-statistics/index.html). [Since 2018](https://www.pewtrusts.org/en/research-and-analysis/fact-sheets/2020/12/medications-for-opioid-use-disorder-improve-patient-outcomes), 2 in 3 drug overdose deaths have been from an opioid (almost 50,000 deaths). Nearly 1.3 million Americans are currently using one or more of the following medications to treat opioid use disorder (OUD): methadone, buprenorphine, and naltrexone. The [National Institute on Drug Abuse](https://nida.nih.gov/)'s [Clinical Trials Network](https://nida.nih.gov/about-nida/organization/cctn/clinical-trials-network-ctn) have funded over 100 clinical trials and clinical trial supplemental studies to study the effects of new and existing medications to treat addiction. Furthermore, opioid use disorder has in the past been predominately a disease of [middle-class white Americans](http://www.doi.org/10.1007/s11013-016-9496-5). However, these demographics have been shifting, and with this shift come exacerbated [health disparities](https://www.addictioncenter.com/news/2019/10/racial-disparities-opioid-addiction-treatment/). 

> Clinically meaningful, patient-centric endpoints beyond abstinence are needed to define success in clinical trials. - Dr. Nora Vulkow, Address to CTN, April 2022

Clinical trials assess the effectiveness of medication-based treatments for OUD (MOUD). A wide variety of treatment outcomes have been used in clinical trials since 1972 (Table 1 shows outcomes from 41 papers assessing MOUD). These endpoints all assess participant success or failure in treatment via the results from scheduled *urine drug screenings* (UDS) or *urine opioid screenings* (UOS). Accurately measuring the efficacy of MOUD for clinical trial participants is paramount, but no "gold standard" trial outcomes exist.

Moreover, trial outcomes commonly used in CTN trials have not been widely assessed for racial / ethnic measurement variance, but some such effects have already been described. For example, racial/ethnic bias was assessed for [OUD trial completion rates](https://www.doi.org/10.1016/j.drugalcdep.2018.06.006), and this treatment outcome was found to change disproportionately based on participant race/ethnicity in large US cities. In clinical trials for OUD, if a treatment outcome has latent racial/ethnic bias (after controlling for relevant clinical factors), then one of two scenarios will occur: (1) if minority subjects are disproportionately marked as treatment successes in error, then the observed quality of an otherwise ineffective therapeutic will be inflated for that subgroup; conversely, (2) if minority subjects are disproportionately marked as treatment failures in error, then the observed quality of an otherwise effective experimental therapeutic will be diminished. Treatment outcomes which depend on race/ethnicity will lead to inequitable over/under-treatment of minority individuals who suffer from OUD.

```{r, import-table-one, include=FALSE}
pathToTable1_char <- system.file(
  "suppl_docs", "definitions_20220405.xlsx", package = "CTNote", mustWork = TRUE
)
tab1_df <- readxl::read_xlsx(pathToTable1_char) 
```

```{r, show-table-one, results='asis'}
tab1_df %>% 
  select(-`Frequency of UOS`, -`Coded column name`, -DOI) %>% 
  rename(
    Group = `Outcome Group`,
    Endpoint = `Primary Endpoint`,
    Class = `Numeric Class`,
    Definition = `Definition/Assessment of Outcome`,
    `Missing is` = `Missing UOS coded as`
  ) %>% 
  mutate(
    Group = case_when(
      str_detect(Group, "Abstinence") ~ "Abstinence",
      str_detect(Group, "Relapse") ~ "Relapse",
      str_detect(Group, "Reduction") ~ "Reduction",
    )
  ) %>% 
  kable("html") %>%
  column_spec(1:4, width = "3cm") %>%
  column_spec(5, width = "5cm") %>%
  kable_styling("striped", font_size = 11) %>%
  kable_minimal() %>% 
  # All styling and spec calls have to come BEFORE this line.
  scroll_box(width = "1000px", height = "500px") 
```

Each row of Table 1 is an outcome used in a past clinical trial for MOUD. As preliminary work, our clinical team grouped these by clinical practice into three classes: *abstinence*, *relapse*, and substance use *reduction*. These classes were further split into subclasses based on their clinical interpretation. Of note, these metrics also differed in how they considered a scheduled but incomplete UDS (i.e. a "missing" UDS). We removed outcomes which could not be used to measure subject-specific outcomes (e.g. "proportion of subjects in treatment group with positive UDS in study week 3"); we removed outcomes which could not yield a univariate metric of subject success (e.g. "number of positive UDS per three-week window over time"); we split papers which assessed multiple outcomes (e.g. complete abstinence between weeks 5-12 AND total number of abstinent weeks), and we combined papers which used identical outcomes. At the end of our literature search, we have `r nrow(tab1_df)` outcomes from registered clinical trials to consider.


## Motivation

Some treatment outcomes may be needlessly sensitive to protected health attributes (such as race, ethnicity, age, and/or sex), which could exacerbate existing health disparities.


    + accurate evaluation of medication-based treatments for OUD (MOUD)
    + health disparities in treatments and treatment outcomes
    + wide variety of treatment 'endpoints' (Table 1)
- Significance and Impact:
    + first empirical (data driven) comparison of MOUD clinical trial endpoints
    + only standard and code-based library of treatment outcome definitions
    + Racial/ethnic sensitivity analysis of clinical trial outcome definitions




*******************************************************************************
</br>


# Methods

- Defining a Use Pattern "Word"
    + The data structure required (weekly or more frequently drawn UDS for each participant)
    + Tuning parameters (grace period and study length). MOVE TO ctn0094DataExtra vignette; we will assume that the use pattern word already exists
    + Use Pattern Examples (Table 2: 5 interesting people)
- The `CTNote::` Package Helper Functions
    + Handling missing data: `recode_missing_visits()` and `impute_missing_visits()`
    + Accounting for the study observation design: `collapse_lattice()` and `view_by_lattice()`
    + Detecting a use pattern: `detect_subpattern()` and `detect_in_window()`
    + Measuring lengths of consecutive behavior: `measure_retention()` and `measure_abstinence_period()`
    + Counting substance use events: `count_matches()`


*******************************************************************************
</br>


# Results

- Examples of Treatment Outcome Definitions
- Clustering Treatment Outcomes
    + Resampled Dendrogram (Figure 1)
- Assessing Racial/Ethnic Sensitivity in Outcomes


*******************************************************************************
</br>


# Discussion

---
title: "Data files needed for CTNote"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Data files needed for CTNote}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo = FALSE}
#library(CTNote)
```

# Data
CTNote assumes that you have you data organized into tables called: rand, demo, drugs, diagnoses, withdrawal.

UPDATE 2021-05-06: currently, the tables in `CTN0094/Harmonization/Nate/dataConversion/data/` have two fixed columns: `who` and `what`. Time-dependent data sets have a `days_since_date_x` column which measures days since some event (but I don't know what that event is). I think that we need a preliminary step to create an analysis data table from the data sets of interest.
UPDATE 2021-05-11: there were some issues with the original directory, so I copied the directory to `CTN0094/Harmonization/GabrielOdom/ctn0094Data/`, then I modified the DESCRIPTION and NAMESPACE so that this package builds.
```{r load_data_package}
library(ctn0094Data)
# data(package = "ctn0094Data")
```
```
alldrugs                
asi             
days          
demographics        
disagree      
everybody     
fagerstom     
firstdate     
psychiatric   
randomization 
rbs           
rbsiv         
screeningdate 
sex           
site                
tlfb                
treatment           
uds                 
withdrawl 
```



All tables have the following variables:

+ project = integer for study number (i.e., CTN-0030 is 30)
+ who = character string with a study id
+ when = date

## `rand` 

`rand` has information on study arm treatment.

+ treatment = character string with description of treatment arm

## `demo` 

This needs to be harmonized

+ age = integer with age in years
+ race = character string with permitted values "White",
+ eth = character string with permitted values 
  * "Hispanic" 
  * "Not Hispanic 

```{r load_demographics}
data("demographics")
head(demographics)
```


## `drugs` 

+ source = where drug was noted
  * UDS
  * TLFB
  * Treatment
+ what = name of drug "Coke",
+ route = how drug is ingested "Nose",
+ unit  
  * "oz"
+ amount = integer with amount given the units 

```{r load_UDS_TLFB}
data("uds")
data("tlfb")

```


## `diagnoses` 
+ issue = character string with name of comorbid diagnoses (e.g.) 
+ result = result of psychatric diagnosis testing 
  * "Y"
  * "N"
  * "U"

## `withdrawl` 

+ severity = "Bad",
+ instrument = "Cows Veresion X" 

# Structure of the data CTNote expects
```{r er_diagram, echo = FALSE, fig.cap="Entity Relationship diagram for data required for CTNote."}
rand <- data.frame(project = c(1), who = c("x"), 
                   when = c(format(Sys.Date(), "%a %b %d")), 
                   treatment = c("Nacos"))
demo <- data.frame(project = c(1), who = c("x"), 
                   when = c(format(Sys.Date(), "%a %b %d")), 
                   age = c(1),
                   race = "White",
                   eth = "Hispanic")                   
drugs <- data.frame(project = c(1), who = c("x"), 
                    when = c(format(Sys.Date(), "%a %b %d")), 
                    what = "Coke",
                    route = "Nose",
                    unit = "oz",
                    amount = 1) 
psych <- data.frame(project = c(1), who = c("x"), 
                    when = c(format(Sys.Date(), "%a %b %d")), 
                    issue = "Depression",
                    result = "Y") 
withdrawl <- data.frame(project = c(1), who = c("x"), 
                        when = c(format(Sys.Date(), "%a %b %d")), 
                        severity = "Bad",
                        instrument = "Cows") 

suppressPackageStartupMessages(library(dm))
ctnote_dm_no_keys <- dm(rand, demo, drugs, psych, withdrawl)

ctnote_dm_only_pks <- 
  ctnote_dm_no_keys %>% 
  dm_add_pk(rand, who) 

ctnote_dm_all_keys <- 
  ctnote_dm_no_keys %>% 
  dm_add_pk(rand, who) %>% 
  dm_add_fk(demo, who, rand) %>% 
  dm_add_fk(drugs, who, rand) %>% 
  dm_add_fk(psych, who, rand) %>% 
  dm_add_fk(withdrawl, who, rand) 

ctnote_dm_all_keys %>% 
  dm_draw(view_type = "all")
```


# What Data Sets we Require of Users
In order to standardize treatment records across subjects, we we need the PI to supply the following data components per person:

- "Day 0": when does the surveillance "begin" for that subject? This could be first contact, randomization, induction (start or end).
- What day of the week is Day 0? This will be critical for any regularly scheduled clinic visits that should happen within a week (for example, MWF for first two weeks, once weekly thereafter)
- Observation rule timings:
    + "subject will present on MWF for first two weeks, ..."
    + "Between day 14-27 (`<TIME PERIOD>`), we expect 2 (`<COUNT>`) visits, ..."
    + Start and stop days for each rule (Rule A is active for day 0 to 13, Rule B is active for weeks 2-6, etc.)
- Observation rule evaluation:
    + "A failure is any number of positive or missing UDS within this window ..."
    + " A failure is more than 2 positive UDS within this window ..."


## Grammar?
"During time period X, when we observe Y, count it as state Z."  
- When is it?
- What do we observe?
    + which variable?
    + adjective: largest, longest consecutive?
- How should we interpret it?
    + metric for success


1. Highlight set of days
2. Specify variable (UDS / TLFB)
3. How to define events: successes or failures? Missings?
4. consecutive events? Y/N
5. How many individual observed events should mark the highlighted date range as a failure/success?

UPDATE 2021-05-13: We aim to have a flexible and robust data structure created from these relational tables by 2 June. This data structure will need to contain both UDS and TLFB data (and perhaps information on the observation windows?). The data structure must follow the form above.

---
title: "An n-Ary Word Sufficient Statistic for Sequential Univariate Categorical Values"
author: "Gabriel Odom, Laura Brandt, Ray Balise, and the CTN-0094 Team"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
    fig_width: 8
    fig_height: 8
vignette: >
  %\VignetteIndexEntry{CTNote: Quinary Words and Algorithms}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<!-- output: rmarkdown::word_document -->

<!-- output: -->
<!--   rmarkdown::html_vignette: -->
<!--     toc: true -->
<!--     toc_depth: 2 -->
<!--     fig_width: 8 -->
<!--     fig_height: 8 -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, load-packages, include=FALSE}
library(ctn0094data)
library(ctn0094DataExtra)
library(CTNote)
library(readxl)
library(kableExtra)
library(tidyverse)
```



# Introduction and Motivation


## Background

Over 750,000 Americans have died from a drug overdose [since 1990](https://www.hhs.gov/opioids/about-the-epidemic/opioid-crisis-statistics/index.html). [Since 2018](https://www.pewtrusts.org/en/research-and-analysis/fact-sheets/2020/12/medications-for-opioid-use-disorder-improve-patient-outcomes). When evaluating the efficacy of new medication-assisted treatments for substance use disorders (SUDs), clinicians require trial participants to provide frequent urine samples, known as *urine drug screenings* (UDS), which are tested for the presence of illicit substances. 

For a single substance or group of substances, outcomes of these tests are uni-dimensional and categorical. Common UDS categories include "substance positive", "substance negative", "improper urine sample temperature", "missing urine", and others. Further, because these tests are given sequentially over the course of a clinical trial, the tests are correlated within subject and across study week. Because of these properties, single-value summaries of the UDS pattern (such as the proportion of "substance positive" results, or the maximum number of consecutive "substance negative" results) are not *sufficient statistics* (they do not contain all of the information about each trial participants' UDS pattern that was contained in the original UDS data) [Fisher, 1922](http://doi.org/10.1098/rsta.1922.0009). 


## Overview of this Paper

In this paper, we extend the concept of a binary word to multiple categories. We show that this construct sufficiently collapses longitudinal records into a single, compact "word". Also, we give a few example algorithms to calculate some common single-value summaries from such a "word". Finally, we introduce a standard and code-based library of algorithms (contained in the `CTNote` R package) for treatment outcome definitions useful to evaluate medication-based treatments for SUDs. 


*******************************************************************************
</br>



# Methods


## Binary and $n$-ary "Words"
[Binary words](https://www.oxfordreference.com/view/10.1093/acref/9780199235940.001.0001/acref-9780199235940-e-293) are a compact representation of a sequence of logical or binary variables. For example, let the random variable $x$ indicate whether or not a clinical trial participant visited their clinic in each week over a four-week period, and assume that we observe the pattern: "visit", "visit", "no visit", "visit". We can represent this clinic visit pattern as the binary word "1101".

Extensions of this concept have been famously applied to the human genome. The four nitrogen bases in DNA are abbreviated by their first letter: A for adenine, T for thymine, G for guanine, and C for cytosine. These four letters are collapsed by their position in the genome into a *quaternary* word (or a *quinary* word if U is included for uracil). Such a quaternary word can be used to sufficiently represent all of the nitrogenous bases observed in the genome in order.


## Substance Use Pattern "Word"

Building from these examples, we aim to create an $n$-ary word [sufficient statistic](https://doi.org/10.1098/rsta.1922.0009) of all weekly UDS results. For laboratory tests to detect a substance of interest in the urine, this statistic is a compact representation of the full pattern of substance use for an individual participant. To be of use, this summary statistic must have the following properties:

1. (*Literacy*) It can be directly parsed by a computer.
2. (*Parsimony*) It can be easily interpreted by a human.
3. (*Sufficiency*) It represents all of the same information about the sequence of interest would be present in the full data.

Notice that all three properties are satisfied for the nucleic acids quinary word. 


## Quinary UDS Pattern Legend

In order to compactly summarize a participant's pattern of use for a particular substance over time, we first define the following five-value legend:

- **+**: positive for the substance(s) in a specified window of time (a day, week, month, etc.) by urine screen (or self report, if such data are of interest)
- **â€“**: negative for the substance(s)
- **o**: subject failed to provide a urine sample
- <b>_</b>: no specimens required (weekends, holidays, pre-randomization period, alternating visit days/weeks)
- <b>*</b>: inconclusive results or mixed results (e.g. subject provided more than one urine sample in the time interval, and they did not agree)


## A Use Pattern Example
```{r}
egWho_int <- 2089L
```

We will first observe the recorded opioid use data via urine screen for a subject after randomization.
```{r results='asis'}
egTab_df <- 
  ctn0094data::all_drugs %>% 
  filter(who == egWho_int) %>% 
  filter(source == "UDSAB") %>% 
  filter(when >= 0) %>% 
  filter(what == "Opioid") %>% 
  arrange(when)
kable(egTab_df)

# if(!knitr::is_html_output()) {
#   "TABLE OF SUBSTANCE USE FOR EXAMPLE PARTICIPANT HERE; SEE .html VERSION "
# } else {
#   egTab_df %>% 
#     kable() %>% 
#     scroll_box(width = "500px", height = "500px")
# }

```

While we observe the study days that this participant used opioids throughout the clinical trial, it's difficult visualize the patient's treatment trajectory using the data in this form. On the one hand, this data can be clearly parsed by a computer (*literacy*), and it represents all of the opioid use for this subject (*sufficiency*). However, data in this form is **not** easy to directly interpret by a clinician or researcher (no *parsimony*). Can we immediately derive clinical intuition about this patient? In contrast, observe the opioid use pattern summary for this same participant: 
```{r}
egUsePattern_char <- 
  ctn0094DataExtra::derived_weeklyOpioidPattern %>% 
  filter(who == egWho_int) %>% 
  # select(who, `Weeks of Treatment` = endWeek, `Opioid Use Pattern` = Phase_1)
  pull(Phase_1)
egUsePattern_char
```

Using the basic pattern definition above, we can clearly see that this subject had a challenging first month (`++++`), improved in the second month (`---+`), and then remained abstinent from opioids for the remainder of the clinical trial (`--------------o-`). Participant substance use pattern data in this form *is* easy to directly interpret by a clinician. Moreover, this symbolic representation of substance use can be parsed and summarized by a computer. Finally, notice that this pattern represents the entire course of treatment for this subject without loss of any clinically relevant information about their opioid misuse.


*******************************************************************************
</br>



# Results

We mentioned above that these use pattern summaries are "computable" (that a computer can parse them). The software package `CTNote::` for the R computing language is one such tool to enable computers to parse these use patterns. This software package contains the following groups of routines (also known as functions):

- Handle missing UDS data with `recode_missing_visits()` and `impute_missing_visits()`
- Account for the study observation design or trial visit protocol with `collapse_lattice()` and `view_by_lattice()`
- Detect a substance use pattern with `detect_subpattern()` and `detect_in_window()`
- Measure the longest periods of consecutive behavior with `measure_retention()` and `measure_abstinence_period()`
- Count the substance use events with `count_matches()`

By executing various combinations of these routines, we were able write algorithms to define many common treatment outcome definitions used in substance use disorder clinical trials. In our supplemental material, we include a "library" of algorithms to calculate each of these definitions. The input of each algorithm is a set of substance use pattern summaries for all clinical trial participants; the output of each algorithm is a calculated treatment endpoint for each participant included in the input.


## Example: Abstinence Outcome

The Schottenfeld et al. (2008) treatment endpoint definition is "the length of the longest period of consecutive opioid abstinence", where missing clinic visits are imputed to represent a urine screen positive for the substance of interest. Therefore, the algorithm to calculate this definition for subject `r egWho_int` would be
```{r, echo=TRUE, eval=FALSE}
# The participant's use pattern summary; the %>% symbol is read "and then"
"++++---+--------------o-" %>% 
  # change all missing visits to positive
  recode_missing_visits(missing_becomes = "+") %>% 
  # find the length of the longest abstinent period, in weeks
  measure_abstinence_period()
```


## Example: Use Reduction Outcome

The Haight et al. (2019) treatment endpoint definition is the "percentage of negative UOS from week 5 to week 24"; because participants included in the CTN-0094 harmonized data set were not all followed for 24 weeks, we truncate this observation window to 15 weeks of study. Therefore, the code to calculate this definition for subject `r egWho_int` would be
```{r, echo=TRUE, eval=FALSE}
count_matches(
  use_pattern = "++++---+--------------o-",
  match_is = "-",
  # Mixed results weeks count as half of a negative week
  mixed_results_are = "*", mixed_weight = 0.5,
  # The end-of-protocol for our trials is 15 weeks
  start = 5, end = 15,
  # Return the proportion instead of the count
  proportion = TRUE
)
```


## Example: Relapse Outcome

The Krupitsky et al. (2006) treatment endpoint has relapse defined as "3 consecutive positive UOS", where missing clinic visits are imputed to represent a urine screen positive for the substance of interest. Therefore, the algorithm to calculate this definition for subject `r egWho_int` would be
```{r, echo=TRUE, eval=FALSE}
"++++---+--------------o-" %>% 
  recode_missing_visits(missing_becomes = "+") %>% 
  # change all mixed-results visits to positive
  recode_missing_visits(missing_is = "*", missing_becomes = "+") %>% 
  # detect if the subject had 3 weeks of positive or missing UDS in a row
  detect_subpattern(subpattern = "+++")
```

If we were interested in relapse from a "time-to-event" or reliability perspective, the algorithm above changes only in the last line:
```{r, echo=TRUE, eval=FALSE}
"++++---+--------------o-" %>% 
  recode_missing_visits(missing_becomes = "+") %>% 
  recode_missing_visits(missing_is = "*", missing_becomes = "+") %>% 
  # detect if the subject had 3 weeks of positive or missing UDS in a row, AND
  #   measure the number of weeks until this pattern *starts*
  detect_in_window(
    # Look at all possible 3-week windows, and
    window_width = 3L,
    # check if any of them have all 3 positive UDS
    threshold = 3L
  )
```


*******************************************************************************
</br>



# Discussion
We believe this `CTNote` package and outcomes library will be useful to all future substance use disorder clinical trials in the National Institute of Drug Abuse (NIDA)'s [Clinical Trials Network](https://nida.nih.gov/about-nida/organization/cctn/clinical-trials-network-ctn) (CTN) and in other substance use disorder research. 

In order to summarize complex substance use patterns over the weeks of the multiple clinical trials, we recommend all dates be standardized to the day of trial consent.

## Use Pattern Limitations    
While this substance use pattern summary satisfies the three conditions necessary to be a "sufficient" statistic mentioned previously, there are three main limitations:

The first limitation surrounds the idea of poly-drug use. These use pattern summaries are substance or substance group specific. Notice that, while this participant does appear to curb their weekly opioid and heroin use during the course of treatment, their cocaine use does *not* decrease over the same time interval. However, the **opioid** use pattern summary can not display information about concurrent **cocaine** use. While this is a current limitation, one of our current areas of research involves expanding the support of substance use pattern "words" to include poly-substance use in a meaningful way (including thee ability to preserve cross-substance correlations).

The second limitation is one of parsimony. In order to ensure that use pattern summaries work regardless of a computer's locale or operating system, we limit the symbols in the "word" to proper symbols from the [American Standard Code for Information Interchange](https://www.ascii-code.com/) (ASCII) list. Technically speaking, there are 128 [7-bit ASCII](https://www.ibm.com/docs/en/aix/7.1?topic=support-ascii-characters) symbols, but only 96 are visible (printable) characters. Put simply, these 96 characters are all the symbols that a traditional North American computer keyboard can make. Therefore, we could define a substance use pattern "word" with any combination of these 96 printable symbols. However, such a visual summary would be incredibly challenging to interpret, consequently failing to meet the requirement that our summary be easily read by a clinician. In the interest of simplicity, we chose the five symbols mentioned above (`+`, `-`, `o`, `*`, and `_`). We recognize that different clinical trial designs may necessitate the introduction of additional symbols to this use pattern summary, but we strongly recommend (due to human [memory constraints](https://doi.org/10.1037/h0043158)) that such lists be kept to seven symbols or fewer. As an example, we discussed the benefit of adding a special symbol for a "missing but excused" clinic visit, but we ultimately did not because such instances were rare in our data.

The third limitation is due to the cold and unfeeling logic of a computer. The computer cannot understand the many extenuating circumstances that pervade our human experience. Worth repeating is the old maxim of computing: "computers give you what you ask for, not what you want." Consider a concrete example: assume a participant was supposed to visit the clinic for a weekly urine test on Thursday, but they came on Wednesday instead due to a conflict at their work; their urine sample from Wednesday came back "clean". What would a nurse at the substance use clinic do in this case? Most people are reasonable; they would count the urine screen for that week as negative for opioids. What would a computer do? Without the direct input of a human to override the clinical trial protocol, a computer would count the negative urine on Wednesday but still mark the participant as a "failure to appear" / "missing urine screen" on Thursday. In many clinical trial protocols, missing urine screens are imputed as "positive" for the substance of interest, so now this participant's use pattern summary is marked `*` (mixed results) instead of `-` (negative results) for that week.

# References
